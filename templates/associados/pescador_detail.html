{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block title %}{{ pescador.nome }} - SPI{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 m-0">{{ pescador.nome }}</h1>
  <div class="d-flex gap-2">
    <a class="btn btn-success" href="{% url 'associados:defeso_dossie_pdf' pescador.pk %}" target="_blank">Dossiê do Defeso</a>
    <a class="btn btn-outline-success" href="{% url 'associados:pescador_ficha' pescador.pk %}" target="_blank">Imprimir ficha</a>
    <a class="btn btn-outline-secondary" href="{% url 'associados:pescador_update' pescador.pk %}">Editar</a>
    <a class="btn btn-outline-primary" href="{% url 'associados:pescador_list' %}">Voltar</a>
  </div>
</div>
<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-body">
        <h2 class="h6 text-uppercase text-muted">Dados</h2>
        <dl class="row mb-0">
          <dt class="col-4">CPF</dt><dd class="col-8">{{ pescador.cpf }}</dd>
          <dt class="col-4">Nascimento</dt><dd class="col-8">{{ pescador.data_nascimento|date:'d/m/Y' }}</dd>
          <dt class="col-4">RGP</dt><dd class="col-8">{{ pescador.rgp }}</dd>
          <dt class="col-4">Telefone</dt><dd class="col-8">{{ pescador.telefone }}</dd>
          <dt class="col-4">Associação</dt><dd class="col-8">{{ pescador.data_associacao|date:'d/m/Y' }}</dd>
        </dl>
        {% if pescador.endereco %}
        <hr>
        <h2 class="h6 text-uppercase text-muted">Endereço</h2>
        <p class="mb-0">{{ pescador.endereco.logradouro }}, {{ pescador.endereco.numero }} {{ pescador.endereco.complemento }}<br>
        {{ pescador.endereco.bairro }} - {{ pescador.endereco.cidade }}/{{ pescador.endereco.estado }} - {{ pescador.endereco.cep }}</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-8">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab">Documentos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="fees-tab" data-bs-toggle="tab" data-bs-target="#fees" type="button" role="tab">Mensalidades</button>
      </li>
    </ul>
    <div class="tab-content border border-top-0 p-3 bg-white" id="myTabContent">
      <div class="tab-pane fade show active" id="docs" role="tabpanel">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <h3 class="h6">Lista</h3>
            <ul class="list-group">
              {% for d in pescador.documentos.all %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ d.get_tipo_display }} <small class="text-muted">({{ d.data_upload|date:'d/m/Y H:i' }})</small></span>
                <a class="btn btn-sm btn-outline-secondary" href="{{ d.arquivo.url }}" target="_blank">Abrir</a>
              </li>
              {% empty %}
              <li class="list-group-item text-center text-muted">Nenhum documento.</li>
              {% endfor %}
            </ul>
          </div>
          <div class="col-12 col-md-6">
            <h3 class="h6">Enviar novo</h3>
            <form method="post" action="{% url 'associados:documento_create' pescador.pk %}" enctype="multipart/form-data">
              {% csrf_token %}
              {{ documento_form|crispy }}
              <button class="btn btn-primary" type="submit">Enviar</button>
            </form>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="fees" role="tabpanel">
        {% if defeso_pode %}
        <div class="alert alert-success" role="alert">
          Pode realizar o pedido do Seguro Defeso. {{ defeso_total_pagas }} competências pagas em {{ defeso_ano }}.
        </div>
        {% else %}
        <div class="alert alert-danger" role="alert">
          Não pode realizar o pedido do Seguro Defeso. {{ defeso_total_pagas }} de 12 competências pagas em {{ defeso_ano }}.
        </div>
        {% endif %}
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
          <h3 class="h6 m-0">Mensalidades</h3>
          <form class="d-flex gap-2" method="post" action="{% url 'associados:mensalidade_adicionar' pescador.pk %}">
            {% csrf_token %}
            <input class="form-control" type="month" name="competencia" required>
            <button class="btn btn-outline-primary" type="submit">Adicionar</button>
          </form>
          <form class="d-flex gap-2" method="post" action="{% url 'associados:mensalidades_gerar_ano' pescador.pk %}">
            {% csrf_token %}
            <input class="form-control" type="number" name="ano" min="1900" max="2100" placeholder="Ano" required>
            <button class="btn btn-outline-success" type="submit">Gerar 12 competências</button>
          </form>
        </div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead><tr><th>Competência</th><th>Valor</th><th>Status</th><th>Pagamento</th><th></th></tr></thead>
            <tbody>
              {% for m in pescador.mensalidades.all %}
              <tr>
                <td>{{ m.competencia|date:'m/Y' }}</td>
                <td>R$ {{ m.valor }}</td>
                <td><span class="badge bg-{% if m.status == 'pago' %}success{% elif m.status == 'pendente' %}warning text-dark{% else %}secondary{% endif %}">{{ m.get_status_display }}</span></td>
                <td>{% if m.data_pagamento %}{{ m.data_pagamento|date:'d/m/Y' }}{% else %}-{% endif %}</td>
                <td class="text-end d-flex justify-content-end gap-1">
                  {% if m.status != 'pago' %}
                  <a class="btn btn-sm btn-primary" href="{% url 'associados:mensalidade_pagar' m.pk %}">Registrar pagamento</a>
                  <form method="post" action="{% url 'associados:mensalidade_excluir' m.pk %}" onsubmit="return confirm('Confirmar exclusão da mensalidade?');">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                  </form>
                  {% else %}
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'associados:recibo_pdf' m.pk %}" target="_blank">Recibo</a>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">Nenhuma mensalidade.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
